services:
  file_finder:
    class: Symfony\Component\Finder\Finder
  event_logger_factory:
    class: SprykerSdk\Sdk\Infrastructure\Service\EventLoggerFactory
    arguments:
      - "@project_setting_repository"
      - "%project_settings_file%"
  event_logger:
    class: SprykerSdk\Sdk\Infrastructure\Service\Logger\EventLogger
    factory: ["@event_logger_factory", "createEventLogger"]
  default_context_receiver:
    class: SprykerSdk\Sdk\Infrastructure\Service\DefaultContextReceiver
    arguments:
        - '@setting_repository'
  action_approver:
    class: SprykerSdk\Sdk\Infrastructure\Service\ActionApprover
    arguments:
      - "@cli_interaction_processor"
  progress_bar:
    class: SprykerSdk\Sdk\Infrastructure\Service\ProgressBar
    tags:
      - {
          name: kernel.event_listener,
          event: console.command,
          method: initProgressBar,
        }
  command_error:
    class: SprykerSdk\Sdk\Infrastructure\Service\ErrorCommandListener
    tags:
      - {
        name: kernel.event_listener,
        event: console.error,
        method: handle,
      }
  setting_repository:
    class: SprykerSdk\Sdk\Infrastructure\Repository\SettingRepository
    arguments:
      - "@doctrine.orm.entity_manager"
      - "@path_resolver"
      - "@yaml_parser"
      - "%sdk_settings%"
  project_setting_repository:
    class: SprykerSdk\Sdk\Infrastructure\Repository\ProjectSettingRepository
    arguments:
      - "@service_container"
      - "@setting_repository"
      - "@yaml_parser"
      - "%project_settings_file%"
      - "@path_resolver"
  yaml_parser:
    class: Symfony\Component\Yaml\Yaml
  task_yaml_repository:
    public: true
    class: SprykerSdk\Sdk\Infrastructure\Repository\TaskYamlRepository
    arguments:
      - "@setting_repository"
      - "@file_finder"
      - "@yaml_parser"
      - "@task.task_from_yaml_builder"
      - !tagged_iterator sdk.task
  context_repository:
    class: SprykerSdk\Sdk\Infrastructure\Repository\ContextFileRepository
    arguments:
      - "@context_serializer"
      - "@setting_repository"
      - "@context.in_memory_cache_storage"
  initializer_service:
    class: SprykerSdk\Sdk\Infrastructure\Service\Initializer
    arguments:
      - "@cli_interaction_processor"
      - "@setting_repository"
      - "@service.task_manager"
      - "@task_yaml_repository"
  process_helper:
    class: Symfony\Component\Console\Helper\ProcessHelper

  local_cli_command_runner:
    class: SprykerSdk\Sdk\Infrastructure\Service\CommandRunner\LocalCliRunner
    tags: ["command.runner"]
    arguments:
      - "@process_helper"
      - "@progress_bar"
  php_command_runner:
    class: SprykerSdk\Sdk\Infrastructure\Service\CommandRunner\PhpCommandRunner
    tags: ["command.runner"]
  cli_interaction_processor:
    class: SprykerSdk\Sdk\Infrastructure\Service\ValueReceiver\CliInteractionProcessor
    tags: ["sdk.cli_receiver_setup"]
    arguments:
      - "@question_helper"
      - "@value_receiver.question_registry"

  value_receiver.question_factory.int:
      class: SprykerSdk\Sdk\Infrastructure\Service\ValueReceiver\QuestionFactory\IntQuestionFactory
      tags: [ "sdk.cli_value_receiver_factory" ]

  value_receiver.question_factory.string:
    class: SprykerSdk\Sdk\Infrastructure\Service\ValueReceiver\QuestionFactory\StringQuestionFactory
    tags: [ "sdk.cli_value_receiver_factory" ]

  value_receiver.question_factory.array:
      class: SprykerSdk\Sdk\Infrastructure\Service\ValueReceiver\QuestionFactory\ArrayQuestionFactory
      tags: [ "sdk.cli_value_receiver_factory" ]

  value_receiver.question_factory.boolean:
      class: SprykerSdk\Sdk\Infrastructure\Service\ValueReceiver\QuestionFactory\BooleanQuestionFactory
      tags: [ "sdk.cli_value_receiver_factory" ]

  value_receiver.question_factory.path:
      class: SprykerSdk\Sdk\Infrastructure\Service\ValueReceiver\QuestionFactory\PathQuestionFactory
      tags: [ "sdk.cli_value_receiver_factory" ]

  value_receiver.question_registry:
      class: SprykerSdk\Sdk\Infrastructure\Service\ValueReceiver\QuestionFactoryRegistry
      arguments:
          - !tagged_iterator { tag: 'sdk.cli_value_receiver_factory', default_index_method: 'getType' }

  cli_receiver_setup_listener:
    class: SprykerSdk\Sdk\Infrastructure\Event\CliReceiverSetupListener
    tags:
      - {
          name: kernel.event_listener,
          event: console.command,
          method: beforeConsoleCommand,
        }
    arguments:
      - !tagged_iterator sdk.cli_receiver_setup
  cli_runner_setup_listener:
    class: SprykerSdk\Sdk\Infrastructure\Event\CliRunnerSetupListener
    tags:
      - {
          name: kernel.event_listener,
          event: console.command,
          method: beforeConsoleCommand,
        }
    arguments:
      - "@local_cli_command_runner"

  value_receiver:
    alias: "cli_interaction_processor"
  autoloader_service:
    class: SprykerSdk\Sdk\Infrastructure\Service\AutoloaderService
    arguments:
      - "%kernel.project_dir%"
  value_resolver_registry:
    class: SprykerSdk\Sdk\Infrastructure\Service\ValueResolverRegistry
    arguments:
      - "@setting_repository"
      - "@value_receiver"
      - !tagged_iterator sdk.value_resolver
      - "@autoloader_service"
      - "%kernel.project_dir%"
  mapper.converter_mapper:
    class: SprykerSdk\Sdk\Infrastructure\Mapper\ConverterMapper
  mapper.command_mapper:
    class: SprykerSdk\Sdk\Infrastructure\Mapper\CommandMapper
    arguments:
      - "@mapper.converter_mapper"
  mapper.placeholder_mapper:
    class: SprykerSdk\Sdk\Infrastructure\Mapper\PlaceholderMapper

  mapper.task_mapper:
    class: SprykerSdk\Sdk\Infrastructure\Mapper\TaskMapper
    arguments:
      - "@mapper.command_mapper"
      - "@mapper.placeholder_mapper"
      - "@mapper.lifecycle_mapper"

  mapper.lifecycle_mapper:
    class: SprykerSdk\Sdk\Infrastructure\Mapper\LifecycleMapper
    arguments:
      - "@mapper.removed_event_mapper"

  mapper.removed_event_mapper:
    class: SprykerSdk\Sdk\Infrastructure\Mapper\RemovedEventMapper
    arguments:
      - "@mapper.placeholder_mapper"
      - "@mapper.command_mapper"
      - "@mapper.file_mapper"

  mapper.file_mapper:
    class: SprykerSdk\Sdk\Infrastructure\Mapper\FileMapper

  task_persistence_repository:
    class: SprykerSdk\Sdk\Infrastructure\Repository\TaskRepository
    arguments:
      - "@mapper.task_mapper"
      - "@doctrine"
      - "@task.task_set_commands_builder"
      - "@task.task_set_override_map_factory"
      - !tagged_iterator sdk.task

  service.task_manager:
    class: SprykerSdk\Sdk\Infrastructure\Service\TaskManager
    arguments:
      - "@event_dispatcher"
      - "@task_persistence_repository"
      - "@task.task_from_task_builder"

  service.lifecycle_manager:
    class: SprykerSdk\Sdk\Infrastructure\Service\LifecycleManager
    arguments:
      - "@task_yaml_repository"
      - "@task_persistence_repository"
      - !tagged_iterator sdk.update_action
      - "%kernel.project_dir%"

  task_created_action:
    class: SprykerSdk\Sdk\Infrastructure\SdkUpdateAction\TaskCreatedAction
    tags: ["sdk.update_action"]
    arguments:
      - "@service.task_manager"

  task_deprecated_action:
    class: SprykerSdk\Sdk\Infrastructure\SdkUpdateAction\TaskDeprecatedAction
    tags: ["sdk.update_action"]
    arguments:
      - "@task_persistence_repository"
      - "@service.task_manager"

  task_removed_action:
    class: SprykerSdk\Sdk\Infrastructure\SdkUpdateAction\TaskRemovedAction
    tags: ["sdk.update_action"]
    arguments:
      - "@service.task_manager"

  task_updated_action:
    class: SprykerSdk\Sdk\Infrastructure\SdkUpdateAction\TaskUpdatedAction
    tags: ["sdk.update_action"]
    arguments:
      - "@service.task_manager"
  output_violation_report_formatter:
    class: SprykerSdk\Sdk\Infrastructure\Violation\Formatter\OutputViolationReportFormatter
    tags: ["sdk.violation_formatter", "sdk.cli_receiver_setup"]
  yaml_violation_report_formatter:
    class: SprykerSdk\Sdk\Infrastructure\Violation\Formatter\YamlViolationReportFormatter
    tags: ["sdk.violation_formatter"]
    arguments:
      - "@violation_report_mapper"
      - "@violation_path_reader"
      - "@yaml_parser"
  workflow_repository:
    class: SprykerSdk\Sdk\Infrastructure\Repository\WorkflowRepository
    arguments:
      - "@doctrine"
  workflow_transition_repository:
    class: SprykerSdk\Sdk\Infrastructure\Repository\WorkflowTransitionRepository
    arguments:
      - "@doctrine"
  violation_report_mapper:
    class: SprykerSdk\Sdk\Infrastructure\Mapper\ViolationReportFileMapper
  violation_path_reader:
    class: SprykerSdk\Sdk\Infrastructure\Violation\ViolationPathReader
    arguments:
      - "@project_setting_repository"
  report_formatter_factory:
    class: SprykerSdk\Sdk\Infrastructure\Violation\ReportFormatterFactory
    arguments:
      - "@context_factory"
      - !tagged_iterator sdk.violation_formatter
  violation_report_repository:
    class: SprykerSdk\Sdk\Infrastructure\Repository\ViolationReportFileRepository
    arguments:
      - "@violation_path_reader"
      - "@report_formatter_factory"
  converter_registry:
    class: SprykerSdk\Sdk\Infrastructure\Service\ConverterRegistry
    arguments:
      - "@setting_repository"
      - "%kernel.project_dir%"

  dynamic_task_set_creator:
    class: SprykerSdk\Sdk\Infrastructure\Service\DynamicTaskSetCreator
    arguments:
      - "@project_setting_repository"
      - "@task_option_builder"
      - "@task_persistence_repository"

  task_option_builder:
    class: SprykerSdk\Sdk\Infrastructure\Service\TaskOptionBuilder
    arguments:
     - '@placeholder_resolver'
  app.event_listener.request_listener:
    class: SprykerSdk\Sdk\Infrastructure\Event\CliSqliteListener
    arguments:
      - "@doctrine"
    tags:
      - {
          name: kernel.event_listener,
          event: console.command,
          method: beforeConsoleCommand,
        }

  app.workflow.guard_listener:
    class: SprykerSdk\Sdk\Infrastructure\Event\Workflow\WorkflowEventListener
    arguments:
      - "@service_container"
    tags:
      - { name: kernel.event_listener, event: console.command, method: setup }
      - { name: kernel.event_listener, event: workflow.guard, method: handle }
      - { name: kernel.event_listener, event: workflow.leave, method: handle }
      - { name: kernel.event_listener, event: workflow.entered, method: handle }

  app.workflow.transition_listener:
    class: SprykerSdk\Sdk\Infrastructure\Event\Workflow\WorkflowTransitionListener
    arguments:
      - "@task_executor"
      - "@workflow_runner"
      - "@project_workflow"
      - "@workflow_repository"
      - "@workflow_transition_repository"
      - "@workflow.transition_resolver_registry"
    tags:
      - { name: kernel.event_listener, event: workflow.transition, method: execute }

  app.workflow.started_transitions_guard_listener:
    class: SprykerSdk\Sdk\Infrastructure\Event\Workflow\WorkflowStartedTransitionListener
    arguments:
      - "@project_workflow"
    tags:
      - { name: kernel.event_listener, event: workflow.guard, method: guard }

  workflow.marking_store.method:
    class: SprykerSdk\Sdk\Infrastructure\Workflow\TimestampedMethodMarkingStore

  service.tasks_repository_installer:
    class: SprykerSdk\Sdk\Infrastructure\Service\TasksRepositoryInstaller
    arguments:
      - "%kernel.project_dir%/.gitmodules"
      - "@logger"

  workflow_runner:
    class: SprykerSdk\Sdk\Infrastructure\Service\WorkflowRunner
    tags: [ "sdk.cli_receiver_setup" ]
    arguments:
      - "@cli_interaction_processor"
      - "@service_container"
      - "@context_factory"

  context.in_memory_cache_storage:
    class: SprykerSdk\Sdk\Infrastructure\Cache\InMemoryContextCacheStorage
  workflow.transition_resolver_registry:
    class: SprykerSdk\Sdk\Infrastructure\Service\WorkflowTransitionResolverRegistry
    arguments:
      - !tagged_iterator workflow.transition_resolver

  task.yaml.commands_factory:
      class: SprykerSdk\Sdk\Infrastructure\Service\TaskSet\Yaml\TaskSetCommandsFactory

  task.yaml.task_set_placeholders_factory:
      class: SprykerSdk\Sdk\Infrastructure\Service\TaskSet\Yaml\TaskSetPlaceholdersFactory

  task.yaml.task_set_override_map_factory:
      class: SprykerSdk\Sdk\Infrastructure\Service\TaskSet\Yaml\TaskSetOverrideMapFactory
      arguments:
          - "@task.task_set_override_map_builder_factory"

  task.task_set_placeholders_builder:
      class: SprykerSdk\Sdk\Infrastructure\Service\TaskSet\TaskSetPlaceholdersBuilder

  task.task_set_commands_builder:
      class: SprykerSdk\Sdk\Infrastructure\Service\TaskSet\TaskSetCommandsBuilder

  task.task_set_override_map_builder_factory:
      class: SprykerSdk\Sdk\Infrastructure\Service\TaskSet\TaskSetOverrideMap\TaskSetOverrideMapDtoBuilderFactory

  task.task_set_override_map_factory:
      class: SprykerSdk\Sdk\Infrastructure\Service\TaskSet\TaskSetOverrideMap\TaskSetOverrideMapDtoFactory

  task.task_from_task_builder:
      class: SprykerSdk\Sdk\Infrastructure\Service\TaskSet\TaskFromTaskSetBuilder
      arguments:
          - "@task.task_set_placeholders_builder"
          - "@task.task_set_commands_builder"
          - "@task.task_set_override_map_factory"

  task.task_from_yaml_builder:
      class: SprykerSdk\Sdk\Infrastructure\Service\TaskSet\TaskFromYamlTaskSetBuilder
      arguments:
          - "@task.yaml.commands_factory"
          - "@task.yaml.task_set_placeholders_factory"
          - "@task.yaml.task_set_override_map_factory"
          - "@task.task_set_placeholders_builder"
          - "@task.task_set_commands_builder"
